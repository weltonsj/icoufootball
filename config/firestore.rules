rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==== Helper Functions ====
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Checa se o usuário tem a custom claim 'admin'
    // A atribuição dessa claim deve ser feita por um script de backend seguro (Firebase Functions)
    function role() {
      return isAuthenticated()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.funcao
        : null;
    }

    function isAdmin() {
      // Compatível: aceita custom claim OU role no documento do usuário
      return request.auth.token.admin == true
        || role() in ['Admin', 'Superadmin'];
    }

    function isSuperadmin() {
      return role() == 'Superadmin';
    }

    function hasGestaoPermission(permission) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissoesGestao[permission] == true;
    }

    function isChanging(fields) {
      return request.resource.data.diff(resource.data).changedKeys().hasAny(fields);
    }

    function onlyChanges(fields) {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(fields);
    }

    function isConversationParticipant(conversaId) {
      return isAuthenticated()
        && request.auth.uid in get(/databases/$(database)/documents/conversas/$(conversaId)).data.participantes;
    }

    // ==== Coleção 'users' ====
    // Perfis de usuários.
    match /users/{userId} {
      // Permite ler perfis básicos (para busca de amigos, ranking público, players em destaque) 
      // ou perfil completo se for público/próprio/admin
      // Leitura pública permitida para exibir classificação e players em destaque na home
      allow read: if true;

      // Escrita (Criar): Um usuário pode criar seu próprio documento.
      allow create: if isOwner(userId);

      // Atualizar:
      // - Dono pode editar campos do próprio perfil, exceto campos sensíveis
      // - Admin pode atualizar qualquer perfil
      // - Inativação/exclusão de terceiros apenas Superadmin
      allow update: if (
        isOwner(userId)
        && !isChanging(['funcao', 'permissoesGestao', 'ativo', 'estrelas', 'ultimoCampeao'])
      ) || (
        isAdmin()
        && (!isChanging(['ativo']) || isSuperadmin())
      );

      // Deleção: própria conta ok; conta de terceiros apenas Superadmin (RF3)
      allow delete: if isOwner(userId) || isSuperadmin();

      // --- Subcoleção 'amigos' ---
      // Lista de amigos do usuário
      match /amigos/{amigoId} {
        // Usuário pode ler sua própria lista de amigos ou se for o amigo
        allow read: if isOwner(userId) || isOwner(amigoId);
        // Usuário pode gerenciar sua própria lista OU adicionar-se na lista do amigo (quando aceita solicitação)
        allow write: if isOwner(userId) || (isAuthenticated() && request.auth.uid == amigoId);
      }
      
      // --- Subcoleção 'configuracoes' ---
      // Configurações pessoais do usuário (temas do chat, preferências, etc.)
      match /configuracoes/{configId} {
        // Usuário pode ler e escrever apenas suas próprias configurações
        allow read, write: if isOwner(userId);
      }
    }

    // ==== Coleção 'solicitacoesAmizade' (schema PRD) ====
    match /solicitacoesAmizade/{solicitacaoId} {
      // Compatível com schema PRD (remetenteId/destinatarioId) e legado (deId/paraId)
      allow read: if isAuthenticated()
        && (
          resource.data.remetenteId == request.auth.uid
          || resource.data.destinatarioId == request.auth.uid
          || resource.data.deId == request.auth.uid
          || resource.data.paraId == request.auth.uid
        );

      // Criar: apenas o remetente (ou deId no legado) pode criar, e nunca para si mesmo
      allow create: if isAuthenticated()
        && request.resource.data.status == 'pendente'
        && (
          (
            request.resource.data.remetenteId is string
            && request.resource.data.destinatarioId is string
            && request.resource.data.remetenteId == request.auth.uid
            && request.resource.data.destinatarioId != request.auth.uid
          )
          ||
          (
            request.resource.data.deId is string
            && request.resource.data.paraId is string
            && request.resource.data.deId == request.auth.uid
            && request.resource.data.paraId != request.auth.uid
          )
        );

      // Atualizar: apenas o destinatário (ou paraId no legado) pode aceitar/recusar
      allow update: if isAuthenticated()
        && resource.data.status == 'pendente'
        && request.resource.data.status in ['aceita', 'recusada']
        && (
          resource.data.destinatarioId == request.auth.uid
          || resource.data.paraId == request.auth.uid
        )
        && onlyChanges(['status', 'respondidoEm', 'dataResposta']);

      allow delete: if isAdmin();
    }

    // ==== Coleção 'notificacoes' (schema PRD: usuarioId) ====
    match /notificacoes/{notificacaoId} {
      allow read: if isAuthenticated() && resource.data.usuarioId == request.auth.uid;

      // Permite criar notificação:
      // - Para si mesmo OU
      // - Para outro usuário se declarado como remetente (metadados.remetenteId ou campo remetenteId) OU
      // - Se for Admin
      allow create: if isAuthenticated()
        && request.resource.data.usuarioId is string
        && request.resource.data.tipo is string
        && request.resource.data.lida == false
        && (
          request.resource.data.usuarioId == request.auth.uid ||
          (request.resource.data.metadados is map && request.resource.data.metadados.remetenteId == request.auth.uid) ||
          (request.resource.data.keys().hasAny(['remetenteId']) && request.resource.data.remetenteId == request.auth.uid) ||
          isAdmin()
        );

      // Dono pode marcar como lida
      allow update: if isAuthenticated()
        && resource.data.usuarioId == request.auth.uid
        && request.resource.data.usuarioId == resource.data.usuarioId
        && onlyChanges(['lida'])
        && request.resource.data.lida == true;

      allow delete: if isAuthenticated() && resource.data.usuarioId == request.auth.uid;
    }

    // ==== Coleção 'campeonatos' ====
    // Contém os dados principais dos campeonatos.
    match /campeonatos/{campeonatoId} {
      // Leitura: Todos podem ver os campeonatos, tabelas, etc.
      allow read: if true;

      // Escrita (Criar, Atualizar, Deletar): Admin ou usuários com permissão de gestão
      allow write: if isAdmin() || (isAuthenticated() && hasGestaoPermission('iniciarRodadas'));

      // --- Subcoleção 'convites' ---
      // Convites/confirmação de presença em campeonatos
      match /convites/{userId} {
        allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
        allow create, delete: if isAdmin();

        // Convidado pode apenas confirmar/recusar (e setar respondidoEm)
        allow update: if isAuthenticated()
          && request.auth.uid == userId
          && resource.data.usuarioId == userId
          && request.resource.data.usuarioId == resource.data.usuarioId
          && request.resource.data.convidadoEm == resource.data.convidadoEm
          && onlyChanges(['status', 'respondidoEm'])
          && resource.data.status == 'pendente'
          && request.resource.data.status in ['confirmado', 'recusado']
          && request.resource.data.respondidoEm is timestamp;
      }

      // --- Subcoleção 'rodadas' ---
      match /rodadas/{rodadaId} {
        allow read: if true;
        allow write: if isAdmin();
        match /partidas/{partidaId} {
          allow read: if true;
          allow update: if isAdmin()
            || (
              isAuthenticated()
              && request.auth.uid == resource.data.jogadorAId
              && resource.data.placarStatus == 'pending'
              && request.resource.data.placarStatus == resource.data.placarStatus
              && request.resource.data.jogadorAId == resource.data.jogadorAId
              && request.resource.data.jogadorBId == resource.data.jogadorBId
              && request.resource.data.placarB == resource.data.placarB
              && request.resource.data.vencedorId == resource.data.vencedorId
              && request.resource.data.linkTransmissao == resource.data.linkTransmissao
              && request.resource.data.championshipId == resource.data.championshipId
              && request.resource.data.rodadaId == resource.data.rodadaId
              && request.resource.data.dataPartida == resource.data.dataPartida
              && request.resource.data.placarA is int
              && request.resource.data.placarA >= 0
            )
            || (
              isAuthenticated()
              && request.auth.uid == resource.data.jogadorBId
              && resource.data.placarStatus == 'pending'
              && request.resource.data.jogadorAId == resource.data.jogadorAId
              && request.resource.data.jogadorBId == resource.data.jogadorBId
              && request.resource.data.placarA == resource.data.placarA
              && request.resource.data.placarB == resource.data.placarB
              && request.resource.data.vencedorId == resource.data.vencedorId
              && request.resource.data.linkTransmissao == resource.data.linkTransmissao
              && request.resource.data.campeonatoId == resource.data.campeonatoId
              && request.resource.data.rodadaId == resource.data.rodadaId
              && request.resource.data.dataPartida == resource.data.dataPartida
              && request.resource.data.placarStatus in ['confirmed', 'contested']
            );
          allow create, delete: if isAdmin();
        }
      }
    }

    match /{path=**}/partidas/{partidaId} {
      allow read: if true;
    }

    // ==== Coleção 'partidas' (RF11 - Partidas entre Amigos) ====
    // Partidas criadas entre amigos fora de campeonatos ou de campeonatos
    match /partidas/{partidaId} {
      // Leitura: Público (para bloco Ao Vivo)
      allow read: if true;
      
      // Criar: Usuários autenticados podem criar partidas
      // - Admin pode criar qualquer partida
      // - Usuário com permissão de gestão pode criar partidas de campeonatos
      // - Usuário pode criar partida onde ele é jogadorA (amistosa)
      allow create: if isAuthenticated() && (
        isAdmin() ||
        hasGestaoPermission('iniciarRodadas') ||
        request.resource.data.jogadorAId == request.auth.uid
      );
      
      // Atualizar: Jogadores participantes, admin ou usuário com permissão de gestão
      allow update: if isAdmin() || 
        hasGestaoPermission('iniciarRodadas') ||
        (isAuthenticated() && 
         (resource.data.jogadorAId == request.auth.uid || 
          resource.data.jogadorBId == request.auth.uid));
      
      // Deletar: Apenas admin ou usuário com permissão de gestão
      allow delete: if isAdmin() || hasGestaoPermission('iniciarRodadas');
    }

    // ==== Coleção 'conversas' (Chat) ====
    // Conversas entre usuários
    match /conversas/{conversaId} {
      // Ler: Usuários autenticados podem ler conversas que participam
      // resource == null permite queries antes de verificar documentos individuais
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participantes;
      
      // Criar: Usuários autenticados podem criar conversas onde estão como participantes
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participantes &&
        request.resource.data.participantes.size() == 2;
      
      // Atualizar: Apenas participantes podem atualizar
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participantes;
      
      // Deletar: Admin ou participante pode deletar
      allow delete: if isAdmin() || 
        (isAuthenticated() && request.auth.uid in resource.data.participantes);

      // --- Subcoleção 'mensagens' ---
      match /mensagens/{mensagemId} {
        // Ler: Usuários autenticados (verificação de participantes no nível da query)
        allow read: if isAuthenticated();
        
        // Criar: Usuário deve ser o remetente
        allow create: if isAuthenticated() && 
          request.resource.data.remetenteId == request.auth.uid;
        
        // Atualizar: Permite marcar como entregue OU lida
        // Destinatário pode marcar mensagens como entregue ou lida
        // Não pode alterar conteúdo ou remetente
        allow update: if isAuthenticated() && 
          resource.data.remetenteId != request.auth.uid &&
          request.resource.data.remetenteId == resource.data.remetenteId &&
          request.resource.data.conteudo == resource.data.conteudo &&
          (
            // Permitir marcar como entregue
            (request.resource.data.entregue == true && 
             request.resource.data.lida == resource.data.lida) ||
            // Permitir marcar como lida
            (request.resource.data.lida == true)
          );
        
        // Deletar: Admin apenas
        allow delete: if isAdmin();
      }
    }

    // ==== Coleção 'logs' ====
    // Logs de atividades críticas do sistema.
    match /logs/{logId} {
      // Apenas admins podem ler ou escrever logs.
      allow read: if isAdmin() || hasGestaoPermission('visualizarLogs');
      allow write: if isAdmin();
    }
  }
}
